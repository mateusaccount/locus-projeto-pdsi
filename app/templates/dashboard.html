{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Locus{% endblock %}

{% block content %}
<div class="bg-[#2F7E32] text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 lg:py-16">
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-center">
            
            <div>
                <h1 class="text-4xl lg:text-5xl font-bold leading-tight mb-4">Compartilhe suas ideias e ajude a melhorar nossa escola!</h1>
                <p class="text-base lg:text-lg opacity-90 mb-8">Proponha soluções, comente e vote nas melhores propostas — colaboração que gera mudanças reais.</p>
                
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <a href="{% url 'app:submeter_ideia' %}" class="bg-white text-[#2F7E32] font-bold py-3 px-8 rounded-full text-lg text-center hover:bg-gray-200 transition">Propor Ideias</a>
                    <a href="{% url 'app:relatar_problema' %}" class="border-2 border-white font-bold py-3 px-8 rounded-full text-lg text-center hover:bg-white hover:text-[#2F7E32] transition">Relatar Problemas</a>
                </div>
            </div>

            <div id="problem-carousel" class="relative mt-8 lg:mt-0">
                <div class="relative h-full min-h-[280px]">
                    {% for problema in problemas_carousel %}
                    <div class="problem-slide absolute inset-0 transition-opacity duration-500 ease-in-out opacity-0" data-index="{{ forloop.counter0 }}">
                        <div class="bg-[#4C9A50] p-6 rounded-2xl shadow-lg h-full flex flex-col justify-between">
                            <div>
                                <div class="flex justify-between items-start mb-4">
                                    <h3 class="text-xl sm:text-2xl font-bold">{{ problema.titulo }}</h3>
                                    <span class="bg-white/20 text-white font-bold text-sm py-1 px-3 rounded-full flex items-center gap-1">
                                        ▲ <span>{{ problema.ideia_set.count }}</span>
                                    </span>
                                </div>
                                <p class="text-sm opacity-80 h-24 overflow-hidden">{{ problema.descricao|truncatewords:25 }}</p>
                            </div>
                            <div class="flex flex-col space-y-2 sm:space-y-0 sm:flex-row justify-between items-start sm:items-center mt-6">
                                <div class="text-xs">
                                    <div class="mb-2"><strong>Área:</strong> {{ problema.get_area_display }}</div>
                                    <div><strong>Local:</strong> {{ problema.localizacao }}</div>
                                </div>
                                <a href="{% url 'app:submeter_ideia' %}?problema={{ problema.id }}" class="bg-white text-[#4C9A50] font-bold py-2 px-6 rounded-full hover:bg-gray-200 transition w-full sm:w-auto text-center">Propor Ideia</a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-center bg-[#4C9A50] p-6 rounded-2xl shadow-lg">Nenhum problema cadastrado para exibir no momento.</p>
                    {% endfor %}
                </div>
                
                {% if problemas_carousel|length > 1 %}
                <button id="prev-btn" class="absolute top-1/2 left-0 transform -translate-y-1/2 bg-white/30 text-white rounded-full w-8 h-8 lg:w-10 lg:h-10 flex items-center justify-center hover:bg-white/50 transition-colors z-10 ml-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 lg:h-6 lg:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <button id="next-btn" class="absolute top-1/2 right-0 transform -translate-y-1/2 bg-white/30 text-white rounded-full w-8 h-8 lg:w-10 lg:h-10 flex items-center justify-center hover:bg-white/50 transition-colors z-10 mr-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 lg:h-6 lg:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
                {% endif %}
            </div>
        </div>

        <div class="mt-16 lg:mt-20">
            <h2 class="text-2xl sm:text-3xl font-bold mb-6 lg:mb-8">Ideias em Destaque</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                {% for ideia in ideias_destaque %}
                <div class="bg-[#4C9A50] p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-xl font-bold">{{ ideia.titulo }}</h4>
                        <span class="text-sm font-bold">☐ {{ ideia.pontuacao }}</span>
                    </div>
                    <p class="text-xs opacity-80 mb-4">Problema: {{ ideia.problema_alvo.titulo|default:"Não especificado" }}</p>
                    <p class="text-sm opacity-90 h-20 overflow-hidden mb-6">{{ ideia.descricao|truncatewords:20 }}</p>
                    
                    <div class="flex flex-col space-y-2 sm:space-y-0 sm:flex-row sm:space-x-4">
                        <a href="{% url 'app:detalhe_ideia' ideia.id %}" class="w-full sm:w-1/2 text-center border-2 border-white font-bold py-2 px-4 rounded-full hover:bg-white hover:text-[#4C9A50] transition">Ver Detalhes</a>
                        <a href="{% url 'app:detalhe_ideia' ideia.id %}" class="w-full sm:w-1/2 text-center border-2 border-white font-bold py-2 px-4 rounded-full hover:bg-white hover:text-[#4C9A50] transition">Votar</a>
                    </div>
                </div>
                {% empty %}
                <p class="col-span-full">Nenhuma ideia em destaque no momento.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    const slides = document.querySelectorAll('.problem-slide');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    let currentIndex = 0;
    
    function showSlide(index) {
        if (!slides.length) return;
        slides.forEach((slide, i) => { 
            if (i === index) { 
                slide.classList.remove('opacity-0'); 
            } else { 
                slide.classList.add('opacity-0'); 
            } 
        });
        if(slides.length > 0) {
            const firstSlide = document.querySelector('.problem-slide[data-index="0"]');
            if(firstSlide && document.querySelectorAll('.problem-slide.opacity-0').length === slides.length) {
                firstSlide.classList.remove('opacity-0');
            }
        }
    }

    if (slides.length > 1 && prevBtn && nextBtn) {
        prevBtn.addEventListener('click', () => { currentIndex = (currentIndex > 0) ? currentIndex - 1 : slides.length - 1; showSlide(currentIndex); });
        nextBtn.addEventListener('click', () => { currentIndex = (currentIndex < slides.length - 1) ? currentIndex + 1 : 0; showSlide(currentIndex); });
    } else if (prevBtn && nextBtn) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
    }
    
    showSlide(currentIndex);
</script>
{% endblock %}